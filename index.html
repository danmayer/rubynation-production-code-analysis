<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=1024, user-scalable=no">

  <title>Production Code Analysis</title>

  <!-- Required stylesheet -->
  <link rel="stylesheet" media="screen" href="core/deck.core.css">

  <!-- Extension CSS files go here. Remove or add as needed. -->
  <link rel="stylesheet" media="screen" href="extensions/goto/deck.goto.css">
  <link rel="stylesheet" media="screen" href="extensions/menu/deck.menu.css">
  <link rel="stylesheet" media="screen" href="extensions/status/deck.status.css">
  <link rel="stylesheet" media="screen" href="extensions/scale/deck.scale.css">

  <link rel="stylesheet" href="highlight/styles/github.css">
  <script src="highlight/highlight.pack.js"></script>

  <!-- Style theme. More available in /themes/style/ or create your own. -->
  <link rel="stylesheet" media="screen" href="themes/style/ls.css">

  <!-- Transition theme. More available in /themes/transition/ or create your own. -->
  <link rel="stylesheet" media="screen" href="themes/transition/horizontal-slide.css">

  <!-- Basic black and white print styles -->
  <link rel="stylesheet" media="print" href="core/print.css">

  <!-- Required Modernizr file -->
  <script src="modernizr.custom.js"></script>
</head>
<body>
  <div class="deck-container">

    <div class="header">
      &nbsp;
    </div>
    <!-- Begin slides. Just make elements with a class of slide. -->

    <section class="slide">
      <h1>Production Code Analysis</h1>
      <p>
        <ul>
	  <li>
	    Dan Mayer (<a href="http://livingsocial.com">LivingSocial</a>)
	    <ul>
	      <li><a href="http://mayerdan.com">http://mayerdan.com</a></li>
	      <li><a href="http://github.com/danmayer">github: @danmayer</a></li>
	      <li><a href="http://twitter.com/danmayer">twitter: @danmayer</a></li>
	    </ul>
	  </li>
        </ul>
      </p>
    </section>

    <section class="slide">
      <h2>You can't improve if you can't measure, or improve what you don't know</h2>
      <p>
        <ul>
	  <li>We often focus on performance and exception monitoring.</li>
      	  <li>Some fixate on test code coverage</li>
	  <li>There is a lot to learn from what the code does in production</li>
	  <li>Ruby tools for this aren't as good as Java's (and other languages), but
      are getting better</li>
          <li>If you know what is happening in production, you also know
      what is not needed</li>
          <li>"Measure Anything, Measure Everything" -Etsy & Thanks for Statsd</li>
        </ul>
      </p>
    </section>
	
    <section class="slide">
      <h2>How Dead Code Sticks Around</h2>
      <p>
        <ul>
	  <li>Large teams aren't good at communicating what is no
      longer needed</li>
      	  <li>AB tests, never removing a loser</li>
	  <li>One offs that are irrelevant over time</li>
	  <li>Deprecation of old endpoints takes time</li>
	  <li>Refactoring accidently leaves dead code paths behind</li>
      	  <li>A developer trying to be 'safe' and creating new methods
      opposed to altering existing methods that have more than one caller</li>
	  <li>There are tests, but it is never used in production</li>
          <li>etc...</li>
	</ul>
      </p>
    </section>

    <section class="slide">
      <h2>Finding Dead Code</h2>
      <p>
        <ul>
      	  <li>Use NewRelic or Appneta (formerly Tracelytics)</li>
	  <li>Stats Instrumentation</li>
	  <li>Production Code Coverage</li>
	  <li>Use Logs</li>
	  <li>At LivingSocial using Stats Instrumentation & Coverband, we have
      removed tens of thousands of lines app of code.<br/>
	  (removing hundreds of thousands if you include CSS, JS,
      tests, and helping to deprecate and shut down services.)</li>
        </ul>
      </p>
    </section>

    <section class="slide">
      <h2>Using 3rd Party tool (NewRelic)</h2>
      <p>Easiest way, look transactions over last 7 days: (note won't
      help with specific formats or never hit endpoints)</p>
      <img src="./images/NR_usage.png" />
    </section>

    <section class="slide">
      <h2>Using 3rd Party tool (NewRelic)</h2>
      <p>LS made a gem to help,
        <a href="https://github.com/livingsocial/newrelic_route_check">newrelic_route_check</a>
      compare NR reports to Rails routes.</br>
	download the `controller_summary.csv`</p>
      <img src="./images/NR_download.png" />
      <p>run `bundle exec rake newrelic:compare_with_routes`</p>
      <pre>
found 335 uniq new relic controller action hits
found 562 uniq Rails routes controller action pairs
exists in new relic, but not in routes: 0
never accessed in new relic stats: ***
Pipeline::DealsController#show
Pipeline::EmailTemplatesController#show
SubscribeButtonController#dropdown_for_deal
SubscribeButtonController#subscribe_to_deal
...
AuthorizationRulesController#graph
AuthorizationRulesController#change
      </pre>
    </section>

    <section class="slide">
      <h2>Stats Instrumentation</h2>
      <p>
        <ul>
      	  <li>Background Events Executed: All events being triggered?</li>
	  <li>Emails Sent: Are you still sending all your mailers?</li>
	  <li>Views Rendered: partials, templates, and layouts</li>
	  <li>One Off Trackers: usage of code
      branches & other hard to verify code</li>
	  <li>Production Performance Comparisons: What's faster on
      production data</li>
	  <li>Translations Usage: How many translation keys are you
      loading in memory & never using</li>
        </ul>
      </p>
    </section>

    <section class="slide">
      <h2>Stats Instrumentation: Background Events Executed</h2>
      <pre><code># Example for Resque background jobs
STATSD = Statsd.new(host, port).tap{|sd| sd.namespace = 'app_name'}

def before_perform(*args)
  STATSD.increment "resque.processed.#{get_event_name}"
end

def after_perform(*args)
  STATSD.increment "resque.completed.#{get_event_name}"
end</code></pre>
    </section>

    <section class="slide">
      <h2>Stats Instrumentation: Emails Sent</h2>
      <pre><code># Example for ActionMailer
STATSD = Statsd.new(host, port).tap{|sd| sd.namespace = 'app_name'}

class BaseMailer < ActionMailer::Base
  def initialize(method_name=nil, *parameters)
    STATSD.increment "mailers.base_mailer.#{method_name}" if method_name
    #...
    super(method_name, *parameters)
  end
end</code></pre>
    </section>
	
    <section class="slide">
      <h2>Stats Instrumentation: Views Rendered</h2>
      <pre><code>ActiveSupport::Notifications.subscribe /render_partial.action_view|render_template.action_view/ do |name, start, finish, id, payload| 
  RenderTracker.track_template(name, start, finish, id, payload) unless name.include?('!') 
end

class RenderTracker
  def self.track_template(name, start, finish, id, payload)
    if file = payload[:identifier]
      Statsd.increment "views.#{file}"
    end
    if layout = payload[:layout]
      Rails.logger.info "[RenderTracker] layout: #{layout}"
    end
  end
end</code></pre>
    </section>

    <section class="slide">
      <h2>Stats Instrumentation: Views Rendered</h2>
      <p>We made a gem for that and some helpers: <a href="https://github.com/livingsocial/flatfoot">Flatfoot</a>
      <pre><code>FLATFOOT = Flatfoot::Tracker.new(Redis.new)

ActiveSupport::Notifications.subscribe /render_partial.action_view|render_template.action_view/ do |name, start, finish, id, payload|
  FLATFOOT.track_views(name, start, finish, id, payload) unless name.include?('!') 
end

FLATFOOT.used_views
=> ["app/views/home/index.html.erb",...

FLATFOOT.unused_views
=> ["app/views/something/_old_partial.html.erb",...</code></pre>
    </section>

    <section class="slide">
      <h2>Stats Instrumentation: One Off Trackers</h2>
      <pre><code># Example Tracking a code path
class HomeController < ApplicationController
  def show
    if request.xhr?
       #some weird logic
       STATSD.increment "deprecated.home_controller.show.xhr"
     end
    respond_to do |format|
        format.html { STATSD.increment "deprecated.home.show.html" }
        format.json { STATSD.increment "deprecated.home.show.json" }
        format.mobile { STATSD.increment "deprecated.home.show.mobile" }
    end
  end
end</code></pre>
    </section>

    <section class="slide">
      <h2>Stats Instrumentation: Production Performance Comparisons</h2>
      <p>shout out to <a href="https://twitter.com/ubermajestix">@ubermajestix (Tyler Montgomery)</a> for showing me the timing trick</a>
      <pre><code>STATSD = Statsd.new(host, port).tap{|sd| sd.namespace = 'app_name'}

def example_html_stripping_method
  strip_method = rand(2)&1 == 0 ? 'nokogiri' : 'strip_tags'
  desc = STATSD.time("application_helper.example_html_stripping_method.#{strip_method}") do
    if strip_method == 'strip_tags'
      strip_tags(desc_raw).gsub(/^\s+/,'').gsub(/\s+$/,'')
    else
      Nokogiri::HTML.parse(desc_raw).text.strip
    end
  end
  #...
end</code></pre>
    </section>

    <section class="slide">
      <h2>Stats Instrumentation: Translations Usage</h2>
      <p>We made a gem for that <a href="https://twitter.com/the_chrismo">@Chrismo (Chris Morris)</a> built: <a href="https://github.com/livingsocial/humperdink">Humperdink</a>
      <pre><code>class KeyTracker
  def initialize(redis, key)
    redis_set = Humperdink::RedisDirtySet.new(:redis => redis, :key => key, :max_dirty_items => 9)
    @tracker = Humperdink::Tracker.new(redis_set, :enabled => true)
  end

  def on_translate(locale, key, options = {})
    begin
      if @tracker.tracker_enabled
        requested_key = normalize_requested_key(key, options)
        @tracker.track(requested_key)
      end
    rescue => e
      @tracker.shutdown(e)
    end
  end
...</code></pre>
    </section>

    <section class="slide">
      <h2>Production Code Coverage: Coverband</h2>
      <p>
        <ul>
	  <li>Based on `set_trace_func`</li>
      	  <li>It would be better to be based on `Coverage` but there is a bug in Ruby</li>
	  <li>(Looking for C help, so I can try to patch Ruby, anyone
      got those skills?)</li>
	  <li>Performance hit reduced by sampling</li>
	  <li>
	    <a href="https://github.com/danmayer/coverband">github.com/danmayer/coverband</a>
	  </li>
          <li>Example Output:
	    <a href="./examples/coverage/index.html" target="blank">churn-site coverage</a>
	  </li>
        </ul>
      </p>
    </section>

   <section class="slide">
      <h2>Production Code Coverage: Coverband</h2>
      <pre><code>baseline = Coverband.parse_baseline
Coverband.configure do |config|
  config.root              = Dir.pwd
  config.redis   = Redis.new(:host => 'redis.host.com')
  config.coverage_baseline = baseline
  config.root_paths        = ['/app/']
  config.ignore            = ['vendor']
  config.startup_delay = Rails.env.production? ? 15 : 1
  config.percentage    = Rails.env.production? ? 20.0 : 90.0
  config.stats         = Statsd.new('stat.my.com', 25)
  config.verbose       = Rails.env.production? ? false: true
end</code></pre>
    </section>

    <section class="slide">
      <h2>Production Code Coverage: Coverband</h2>
      <pre><code>#configure rake
require 'coverband'
Coverband.configure
require 'coverband/tasks'

#setup middleware in `config.ru`
require File.dirname(__FILE__) + '/config/environment'
require 'coverband'
Coverband.configure

use Coverband::Middleware
run ActionController::Dispatcher.new</code></pre>
    </section>

    <section class="slide">
      <h2>Logs</h2>
      <p>
        <ul>
	  <li>Logs need to be searchable, real time is best.
	  (ElasticSearch/Kibana, Splunk, Hadoop)</li>
	  <li>All your logs should be in one place 
	  (cron, nginx access/error, background jobs, rails logs)</li>
      	  <li>If you have multiple apps that communicate they should
      be in the same system.</li>
          <li>Try to standardize log format & some keys / variables
      across systems</li>
        </ul>
      </p>
    </section>

    <section class="slide">
      <h2>Logs: Better with Imprint</h2>
      <p>Another LS gem
	<a href="https://github.com/livingsocial/imprint">Imprint</a>
	 <ul>
	   <li>Request tracing in logs:<br/>
	    All Rails.logger calls during a request tagged with a trace_id</li>
	   <li>Exceptions include trace_id so you can fetch all logs
      related to a request that caused an exception</li>
           <li>Background Jobs failures include the trace_id to find
      the request that queued the job</li>
           <li>Cross app tracing, have client gems pass a header, and
      back end APIs will include the same trace_id as the initial
      front end request</li>
	 </ul>
      </p>
	
    </section>

    <section class="slide ls">
      <h1>Thanks</h1>
      <p>
        <ul>
	  <li>
	    Dan Mayer
	    <ul>
	      <li><a href="http://mayerdan.com">http://mayerdan.com</a></li>
	      <li><a href="http://github.com/danmayer">github: @danmayer</a></li>
	      <li><a href="http://twitter.com/danmayer">twitter: @danmayer</a></li>
	    </ul>
	  </li>
	  <li><a href="http://livingsocial.com">LivingSocial</a>
      (We're hiring)<br/>
	  Thanks for sending me to various conferences!
	  </li>
        </ul>
      </p>
    </section>

    <!-- End slides. -->

    <!-- Begin extension snippets. Add or remove as needed. -->

    <!-- deck.status snippet -->
    <p class="deck-status" aria-role="status">
      <span class="deck-status-current"></span>
      /
      <span class="deck-status-total"></span>
    </p>

    <!-- deck.goto snippet -->
    <form action="." method="get" class="goto-form">
      <label for="goto-slide">Go to slide:</label>
      <input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
      <datalist id="goto-datalist"></datalist>
      <input type="submit" value="Go">
    </form>

    <!-- End extension snippets. -->
  </div>

<!-- Required JS files. -->
<script src="jquery.min.js"></script>
<script src="core/deck.core.js"></script>

<!-- Extension JS files. Add or remove as needed. -->
<script src="extensions/menu/deck.menu.js"></script>
<script src="extensions/goto/deck.goto.js"></script>
<script src="extensions/status/deck.status.js"></script>
<script src="extensions/navigation/deck.navigation.js"></script>
<script src="extensions/scale/deck.scale.js"></script>

<!-- Initialize the deck. You can put this in an external file if desired. -->
<script>
  $(function() {
    $.deck('.slide');
  });
</script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
